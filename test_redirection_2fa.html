<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Redirection 2FA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .button-primary { background-color: #007bff; color: white; }
        .button-secondary { background-color: #6c757d; color: white; }
        .button-success { background-color: #28a745; color: white; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>

<body>
    <h1>üîê Test Redirection 2FA</h1>

    <div class="test-case info">
        <h3>üìã Diagnostic du probl√®me de redirection apr√®s validation 2FA</h3>
        <p>Ce test simule le flux complet de validation 2FA et v√©rifie pourquoi la redirection ne fonctionne pas</p>
    </div>

    <div class="test-case">
        <h3>üß™ Test 1: Simulation de la validation 2FA r√©ussie</h3>
        <div>
            <label>Type d'utilisateur :</label>
            <select id="user-type">
                <option value="patient">Patient</option>
                <option value="professionnel">Professionnel (m√©decin)</option>
            </select>
            <button onclick="test2FASuccess()" class="button button-primary">Tester Validation 2FA</button>
        </div>
        <div id="result-2fa-success"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 2: Simulation de handle2FASuccess</h3>
        <div>
            <button onclick="testHandle2FASuccess()" class="button button-secondary">Tester handle2FASuccess</button>
        </div>
        <div id="result-handle-success"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 3: Simulation de la redirection</h3>
        <div>
            <button onclick="testRedirection()" class="button button-success">Tester Redirection</button>
        </div>
        <div id="result-redirection"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 4: Flux complet avec logs</h3>
        <div>
            <button onclick="testCompleteFlow()" class="button button-primary">Tester Flux Complet</button>
        </div>
        <div id="result-complete"></div>
    </div>

    <script>
        // Simulation des donn√©es utilisateur
        let mockUserData = null;
        let mockSelectedProfile = '';
        let mockSelectedProfessional = '';

        // Simulation de la fonction handle2FASuccess de connexion.js
        function handle2FASuccess() {
            console.log('‚úÖ 2FA valid√©e avec succ√®s, redirection...');
            console.log('üîç DEBUG - Donn√©es disponibles pour la redirection:', {
                userData: mockUserData ? Object.keys(mockUserData) : 'NULL',
                selectedProfile: mockSelectedProfile,
                selectedProfessional: mockSelectedProfessional,
                userDataType: mockUserData?.type,
                userDataId: mockUserData?.id_patient || mockUserData?.id
            });
            
            // üîê STOCKAGE DES TOKENS D'AUTHENTIFICATION APR√àS 2FA R√âUSSIE
            try {
                // V√©rifier si les tokens ont d√©j√† √©t√© stock√©s par Setup2FA
                const existingJWT = localStorage.getItem('jwt');
                const existingToken = localStorage.getItem('token');
                const existingPatient = localStorage.getItem('patient');
                const existingMedecin = localStorage.getItem('medecin');
                
                console.log('üîê DEBUG - Tokens existants dans localStorage:', {
                    jwt: existingJWT,
                    token: existingToken,
                    patient: existingPatient,
                    medecin: existingMedecin
                });
                
                // Si aucun token n'a √©t√© stock√© par Setup2FA, stocker les donn√©es essentielles
                if (!existingJWT && !existingToken) {
                    console.log('‚ö†Ô∏è DEBUG - Aucun token trouv√©, stockage des donn√©es essentielles');
                    
                    if (mockUserData && mockSelectedProfile === 'patient') {
                        // Pour les patients, stocker le secret 2FA et les donn√©es essentielles
                        if (mockUserData.two_factor_secret) {
                            localStorage.setItem('two_factor_secret', mockUserData.two_factor_secret);
                        }
                        
                        // Stocker les donn√©es patient essentielles
                        const patientDataToStore = {
                            id_patient: mockUserData.id_patient || mockUserData.id,
                            nom: mockUserData.nom,
                            prenom: mockUserData.prenom,
                            numero_assure: mockUserData.numero_assure,
                            two_factor_enabled: mockUserData.two_factor_enabled,
                            two_factor_secret: mockUserData.two_factor_secret
                        };
                        
                        localStorage.setItem('patient', JSON.stringify(patientDataToStore));
                        console.log('üîê DEBUG - Donn√©es patient stock√©es:', patientDataToStore);
                        
                        // üîë UTILISER LE TOKEN ORIGINAL DE LA PREMI√àRE AUTHENTIFICATION
                        if (mockUserData.originalJWT) {
                            localStorage.setItem('jwt', mockUserData.originalJWT);
                            console.log('üîê DEBUG - JWT original patient r√©utilis√©:', mockUserData.originalJWT.substring(0, 20) + '...');
                        } else if (mockUserData.tempTokenId) {
                            // Fallback sur tempTokenId si pas de token original
                            localStorage.setItem('jwt', mockUserData.tempTokenId);
                            console.log('üîê DEBUG - tempTokenId utilis√© comme JWT temporaire:', mockUserData.tempTokenId);
                        }
                        
                    } else if (mockUserData && mockSelectedProfile === 'professionnel') {
                        // Pour les professionnels, stocker le secret 2FA et les donn√©es
                        if (mockUserData.two_factor_secret) {
                            localStorage.setItem('two_factor_secret', mockUserData.two_factor_secret);
                        }
                        
                        // Stocker les donn√©es professionnel
                        const profDataToStore = {
                            id: mockUserData.id || mockUserData.id_professionnel,
                            nom: mockUserData.nom,
                            prenom: mockUserData.prenom,
                            role: mockSelectedProfessional,
                            two_factor_enabled: mockUserData.two_factor_enabled,
                            two_factor_secret: mockUserData.two_factor_secret
                        };
                        
                        if (mockSelectedProfessional === 'medecin') {
                            localStorage.setItem('medecin', JSON.stringify(profDataToStore));
                            console.log('üîê DEBUG - Donn√©es m√©decin stock√©es:', profDataToStore);
                        }
                        
                        // üîë UTILISER LE TOKEN ORIGINAL DE LA PREMI√àRE AUTHENTIFICATION
                        if (mockUserData.originalToken) {
                            localStorage.setItem('token', mockUserData.originalToken);
                            console.log('üîê DEBUG - Token original professionnel r√©utilis√©:', mockUserData.originalToken.substring(0, 20) + '...');
                        } else if (mockUserData.originalJWT) {
                            localStorage.setItem('token', mockUserData.originalJWT);
                            console.log('üîê DEBUG - JWT original professionnel r√©utilis√©:', mockUserData.originalToken.substring(0, 20) + '...');
                        } else if (mockUserData.tempTokenId) {
                            // Fallback sur tempTokenId si pas de token original
                            localStorage.setItem('token', mockUserData.tempTokenId);
                            console.log('üîê DEBUG - tempTokenId utilis√© comme token temporaire:', mockUserData.tempTokenId);
                        }
                    }
                } else {
                    console.log('‚úÖ DEBUG - Tokens d√©j√† pr√©sents, pas de stockage suppl√©mentaire n√©cessaire');
                }
                
                console.log('üîê DEBUG - localStorage final:', {
                    jwt: localStorage.getItem('jwt'),
                    token: localStorage.getItem('token'),
                    tempTokenId: localStorage.getItem('tempTokenId'),
                    patient: localStorage.getItem('patient'),
                    medecin: localStorage.getItem('medecin'),
                    two_factor_secret: localStorage.getItem('two_factor_secret')
                });
                
            } catch (error) {
                console.error('‚ùå DEBUG - Erreur lors du stockage des tokens:', error);
            }
            
            // Redirection selon le type d'utilisateur
            if (mockUserData) {
                switch (mockSelectedProfile) {
                    case 'patient':
                        console.log('üîµ DEBUG - Redirection patient vers /dmp');
                        // Simuler la redirection
                        simulateRedirection('/dmp');
                        break;
                    case 'professionnel':
                        if (mockSelectedProfessional === 'medecin') {
                            console.log('üü¢ DEBUG - Redirection m√©decin vers /medecin');
                            simulateRedirection('/medecin');
                        } else if (mockSelectedProfessional === 'administrateur') {
                            console.log('üü° DEBUG - Redirection admin vers /admin');
                            simulateRedirection('/admin');
                        } else if (mockSelectedProfessional === 'secretaire') {
                            console.log('üü° DEBUG - Redirection secr√©taire vers /secretariat');
                            simulateRedirection('/secretariat');
                        }
                        break;
                    default:
                        console.log('‚ö†Ô∏è DEBUG - Profil non reconnu, redirection par d√©faut vers /admin');
                        simulateRedirection('/admin');
                }
            } else {
                console.error('‚ùå DEBUG - userData est null, impossible de rediriger');
            }
        }

        // Simulation de la redirection
        function simulateRedirection(path) {
            console.log(`üöÄ Simulation de redirection vers: ${path}`);
            
            // Simuler un d√©lai de redirection
            setTimeout(() => {
                console.log(`‚úÖ Redirection simul√©e vers ${path} r√©ussie`);
                document.getElementById('result-redirection').innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Redirection simul√©e r√©ussie:</h4>
                        <p><strong>Destination:</strong> ${path}</p>
                        <p><strong>Statut:</strong> Redirection effectu√©e</p>
                        <p><strong>Note:</strong> Dans l'application r√©elle, cette redirection utiliserait React Router</p>
                    </div>
                `;
            }, 1000);
        }

        // Test 1: Simulation de la validation 2FA r√©ussie
        function test2FASuccess() {
            const result = document.getElementById('result-2fa-success');
            const userType = document.getElementById('user-type').value;
            
            // Simuler les donn√©es utilisateur selon le type
            if (userType === 'patient') {
                mockUserData = {
                    id_patient: 123,
                    nom: 'Dupont',
                    prenom: 'Jean',
                    numero_assure: '1234567890123',
                    two_factor_enabled: true,
                    two_factor_secret: 'JBSWY3DPEHPK3PXP',
                    originalJWT: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
                    tempTokenId: 'temp_123_456'
                };
                mockSelectedProfile = 'patient';
                mockSelectedProfessional = '';
            } else {
                mockUserData = {
                    id: 79,
                    id_professionnel: 79,
                    nom: 'Sakura',
                    prenom: 'Saza',
                    numero_adeli: 'AH23456780',
                    two_factor_enabled: true,
                    two_factor_secret: 'JBSWY3DPEHPK3PXP',
                    originalToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...',
                    tempTokenId: 'temp_79_456'
                };
                mockSelectedProfile = 'professionnel';
                mockSelectedProfessional = 'medecin';
            }
            
            result.innerHTML = `
                <div class="success">
                    <h4>‚úÖ Validation 2FA simul√©e:</h4>
                    <pre>Donn√©es utilisateur: ${JSON.stringify(mockUserData, null, 2)}</pre>
                    <p><strong>Profil s√©lectionn√©:</strong> ${mockSelectedProfile}</p>
                    <p><strong>Type professionnel:</strong> ${mockSelectedProfessional || 'N/A'}</p>
                    <p><strong>2FA activ√©:</strong> ${mockUserData.two_factor_enabled ? 'Oui' : 'Non'}</p>
                </div>
            `;
        }

        // Test 2: Simulation de handle2FASuccess
        function testHandle2FASuccess() {
            const result = document.getElementById('result-handle-success');
            
            if (!mockUserData) {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erreur:</h4>
                        <p>Veuillez d'abord ex√©cuter le test de validation 2FA</p>
                    </div>
                `;
                return;
            }
            
            result.innerHTML = `
                <div class="info">
                    <h4>üîÑ Ex√©cution de handle2FASuccess...</h4>
                    <p>V√©rifiez la console pour les logs d√©taill√©s</p>
                </div>
            `;
            
            // Ex√©cuter handle2FASuccess
            handle2FASuccess();
            
            setTimeout(() => {
                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ handle2FASuccess ex√©cut√©:</h4>
                        <p><strong>Stockage des tokens:</strong> V√©rifi√©</p>
                        <p><strong>Logs de d√©bogage:</strong> Disponibles dans la console</p>
                        <p><strong>Redirection:</strong> En cours de simulation</p>
                    </div>
                `;
            }, 1500);
        }

        // Test 3: Simulation de la redirection
        function testRedirection() {
            const result = document.getElementById('result-redirection');
            
            if (!mockUserData) {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Erreur:</h4>
                        <p>Veuillez d'abord ex√©cuter le test de validation 2FA</p>
                    </div>
                `;
                return;
            }
            
            // D√©terminer la destination selon le profil
            let destination = '';
            if (mockSelectedProfile === 'patient') {
                destination = '/dmp';
            } else if (mockSelectedProfile === 'professionnel' && mockSelectedProfessional === 'medecin') {
                destination = '/medecin';
            }
            
            result.innerHTML = `
                <div class="info">
                    <h4>üîÑ Test de redirection...</h4>
                    <p><strong>Destination attendue:</strong> ${destination}</p>
                    <p><strong>Profil:</strong> ${mockSelectedProfile}</p>
                </div>
            `;
            
            // Simuler la redirection
            simulateRedirection(destination);
        }

        // Test 4: Flux complet avec logs
        function testCompleteFlow() {
            const result = document.getElementById('result-complete');
            
            result.innerHTML = `
                <div class="info">
                    <h4>üîÑ Test du flux complet...</h4>
                    <p>Ex√©cution s√©quentielle de tous les tests</p>
                    <div class="animate-spin">‚è≥</div>
                </div>
            `;
            
            // Ex√©cuter le flux complet
            setTimeout(() => {
                test2FASuccess();
                
                setTimeout(() => {
                    testHandle2FASuccess();
                    
                    setTimeout(() => {
                        testRedirection();
                        
                        setTimeout(() => {
                            result.innerHTML = `
                                <div class="success">
                                    <h4>‚úÖ Flux complet termin√©:</h4>
                                    <p><strong>Validation 2FA:</strong> ‚úÖ R√©ussie</p>
                                    <p><strong>handle2FASuccess:</strong> ‚úÖ Ex√©cut√©</p>
                                    <p><strong>Redirection:</strong> ‚úÖ Simul√©e</p>
                                    <p><strong>Logs:</strong> Disponibles dans la console</strong></p>
                                </div>
                            `;
                        }, 2000);
                    }, 2000);
                }, 1000);
            }, 500);
        }

        // Initialisation
        window.onload = function () {
            console.log('üîê Test Redirection 2FA - Charg√©');
            console.log('üìä Fonctions disponibles:', {
                handle2FASuccess: typeof handle2FASuccess,
                simulateRedirection: typeof simulateRedirection
            });
        };
    </script>
</body>

</html>
