<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Contexte DMP</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-danger { background-color: #dc3545; color: white; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test Contexte DMP</h1>
    
    <div class="test-section">
        <h2>Test 1: Simulation du Contexte DMP</h2>
        <p>Test de la structure du contexte et de la gestion des donn√©es</p>
        <button class="btn-primary" onclick="testDMPContext()">Tester le Contexte DMP</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Simulation des Actions DMP</h2>
        <p>Test des actions de chargement des donn√©es</p>
        <button class="btn-warning" onclick="testDMPActions()">Tester les Actions DMP</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Simulation du Hook useDMP</h2>
        <p>Test du hook useDMP et de ses retours</p>
        <button class="btn-success" onclick="testUseDMPHook()">Tester le Hook useDMP</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Int√©gration Compl√®te</h2>
        <p>Test de l'int√©gration compl√®te du syst√®me DMP</p>
        <button class="btn-danger" onclick="testFullIntegration()">Tester l'Int√©gration</button>
        <div id="test4-result"></div>
    </div>

    <script>
        // Test 1: Simulation du Contexte DMP
        function testDMPContext() {
            const resultDiv = document.getElementById('test1-result');
            
            try {
                // Simuler l'√©tat initial du contexte DMP
                const mockDMPState = {
                    patientId: 5,
                    dmpData: null,
                    historique: [],
                    journal: [],
                    autoMesures: [],
                    rendezVous: [],
                    documents: [],
                    droitsAcces: [],
                    bibliotheque: [],
                    statistiques: {},
                    loading: false,
                    error: null,
                    lastUpdate: null
                };

                // Simuler le reducer
                const mockReducer = (state, action) => {
                    switch (action.type) {
                        case 'SET_DOCUMENTS':
                            return { ...state, documents: action.payload || [] };
                        case 'SET_AUTO_MESURES':
                            return { ...state, autoMesures: action.payload || [] };
                        case 'SET_HISTORIQUE':
                            return { ...state, historique: action.payload || [] };
                        case 'SET_RENDEZ_VOUS':
                            return { ...state, rendezVous: action.payload || [] };
                        case 'SET_JOURNAL':
                            return { ...state, journal: action.payload || [] };
                        case 'SET_DROITS_ACCES':
                            return { ...state, droitsAcces: action.payload || [] };
                        case 'SET_BIBLIOTHEQUE':
                            return { ...state, bibliotheque: action.payload || [] };
                        default:
                            return state;
                    }
                };

                // Tester quelques actions
                let currentState = { ...mockDMPState };
                
                // Simuler le chargement de documents
                currentState = mockReducer(currentState, { 
                    type: 'SET_DOCUMENTS', 
                    payload: [{ id: 1, type: 'prescription' }, { id: 2, type: 'ordonnance' }] 
                });
                
                // Simuler le chargement d'auto-mesures
                currentState = mockReducer(currentState, { 
                    type: 'SET_AUTO_MESURES', 
                    payload: [{ id: 1, type_mesure: 'temperature', date_mesure: '2025-01-23' }] 
                });

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Contexte DMP fonctionnel !</h4>
                        <p><strong>√âtat initial:</strong></p>
                        <pre>${JSON.stringify(mockDMPState, null, 2)}</pre>
                        <p><strong>√âtat apr√®s actions:</strong></p>
                        <pre>${JSON.stringify(currentState, null, 2)}</pre>
                        <p><strong>V√©rifications:</strong></p>
                        <ul>
                            <li>Documents: ${currentState.documents.length} (attendu: 2)</li>
                            <li>Auto-mesures: ${currentState.autoMesures.length} (attendu: 1)</li>
                            <li>Patient ID: ${currentState.patientId} (attendu: 5)</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test √©chou√© !</h4>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test 2: Simulation des Actions DMP
        function testDMPActions() {
            const resultDiv = document.getElementById('test2-result');
            
            try {
                // Simuler les actions DMP
                const mockActions = {
                    loadDocuments: async () => {
                        console.log('üìÑ Chargement des documents...');
                        return [{ id: 1, type: 'prescription' }, { id: 2, type: 'ordonnance' }];
                    },
                    loadAutoMesures: async () => {
                        console.log('üìä Chargement des auto-mesures...');
                        return [{ id: 1, type_mesure: 'temperature', date_mesure: '2025-01-23' }];
                    },
                    loadHistorique: async () => {
                        console.log('üìö Chargement de l\'historique...');
                        return [{ id: 1, type: 'consultation', date: '2025-01-20' }];
                    }
                };

                // Tester les actions
                const testActions = async () => {
                    const results = [];
                    
                    try {
                        const documents = await mockActions.loadDocuments();
                        results.push(`‚úÖ Documents: ${documents.length} charg√©s`);
                    } catch (error) {
                        results.push(`‚ùå Documents: ${error.message}`);
                    }
                    
                    try {
                        const autoMesures = await mockActions.loadAutoMesures();
                        results.push(`‚úÖ Auto-mesures: ${autoMesures.length} charg√©es`);
                    } catch (error) {
                        results.push(`‚ùå Auto-mesures: ${error.message}`);
                    }
                    
                    try {
                        const historique = await mockActions.loadHistorique();
                        results.push(`‚úÖ Historique: ${historique.length} charg√©`);
                    } catch (error) {
                        results.push(`‚ùå Historique: ${error.message}`);
                    }
                    
                    return results;
                };

                testActions().then(results => {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Actions DMP fonctionnelles !</h4>
                            <p><strong>R√©sultats des actions:</strong></p>
                            <pre>${results.join('\n')}</pre>
                        </div>
                    `;
                });

            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test √©chou√© !</h4>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test 3: Simulation du Hook useDMP
        function testUseDMPHook() {
            const resultDiv = document.getElementById('test3-result');
            
            try {
                // Simuler le hook useDMP
                const mockUseDMP = () => {
                    const mockState = {
                        autoMesures: [{ id: 1, type_mesure: 'temperature', date_mesure: '2025-01-23' }],
                        documents: [{ id: 1, type: 'prescription' }, { id: 2, type: 'ordonnance' }],
                        rendezVous: [{ id: 1, date: '2025-02-01', statut: 'confirme' }],
                        historique: [{ id: 1, type: 'consultation', date: '2025-01-20' }]
                    };

                    const mockActions = {
                        loadDocuments: () => console.log('Chargement documents'),
                        loadAutoMesures: () => console.log('Chargement auto-mesures')
                    };

                    // Fonctions utilitaires
                    const getStatistiquesResume = () => {
                        const autoMesures = Array.isArray(mockState.autoMesures) ? mockState.autoMesures : [];
                        const documents = Array.isArray(mockState.documents) ? mockState.documents : [];
                        const rendezVous = Array.isArray(mockState.rendezVous) ? mockState.rendezVous : [];
                        const historique = Array.isArray(mockState.historique) ? mockState.historique : [];
                        
                        return {
                            totalAutoMesures: autoMesures.length,
                            totalDocuments: documents.length,
                            totalRendezVous: rendezVous.length,
                            totalHistorique: historique.length
                        };
                    };

                    return {
                        ...mockState,
                        ...mockActions,
                        getStatistiquesResume
                    };
                };

                // Tester le hook
                const dmpHook = mockUseDMP();
                const stats = dmpHook.getStatistiquesResume();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Hook useDMP fonctionnel !</h4>
                        <p><strong>Donn√©es retourn√©es:</strong></p>
                        <pre>${JSON.stringify(dmpHook, null, 2)}</pre>
                        <p><strong>Statistiques calcul√©es:</strong></p>
                        <pre>${JSON.stringify(stats, null, 2)}</pre>
                        <p><strong>V√©rifications:</strong></p>
                        <ul>
                            <li>Auto-mesures: ${dmpHook.autoMesures.length} (attendu: 1)</li>
                            <li>Documents: ${dmpHook.documents.length} (attendu: 2)</li>
                            <li>Rendez-vous: ${dmpHook.rendezVous.length} (attendu: 1)</li>
                            <li>Historique: ${dmpHook.historique.length} (attendu: 1)</li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test √©chou√© !</h4>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Test 4: Int√©gration Compl√®te
        function testFullIntegration() {
            const resultDiv = document.getElementById('test4-result');
            
            try {
                // Simuler l'int√©gration compl√®te
                const mockIntegration = {
                    context: {
                        state: {
                            patientId: 5,
                            autoMesures: [{ id: 1, type_mesure: 'temperature' }],
                            documents: [{ id: 1, type: 'prescription' }],
                            rendezVous: [{ id: 1, date: '2025-02-01' }],
                            historique: [{ id: 1, type: 'consultation' }]
                        },
                        actions: {
                            loadDocuments: () => Promise.resolve([{ id: 1, type: 'prescription' }]),
                            loadAutoMesures: () => Promise.resolve([{ id: 1, type_mesure: 'temperature' }])
                        }
                    },
                    hook: {
                        autoMesures: [{ id: 1, type_mesure: 'temperature' }],
                        documents: [{ id: 1, type: 'prescription' }],
                        getStatistiquesResume: function() {
                            return {
                                totalAutoMesures: this.autoMesures.length,
                                totalDocuments: this.documents.length,
                                totalRendezVous: 1,
                                totalHistorique: 1
                            };
                        }
                    },
                    component: {
                        calculateStats: function() {
                            try {
                                const autoMesures = Array.isArray(this.hook.autoMesures) ? this.hook.autoMesures : [];
                                const documents = Array.isArray(this.hook.documents) ? this.hook.documents : [];
                                
                                return {
                                    totalAutoMesures: autoMesures.length,
                                    totalDocuments: documents.length,
                                    totalRendezVous: 1,
                                    totalHistorique: 1
                                };
                            } catch (error) {
                                console.error('Erreur lors du calcul des statistiques:', error);
                                return { totalAutoMesures: 0, totalDocuments: 0, totalRendezVous: 0, totalHistorique: 0 };
                            }
                        }
                    }
                };

                // Tester l'int√©gration
                const stats = mockIntegration.component.calculateStats();
                const hookStats = mockIntegration.hook.getStatistiquesResume();

                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Int√©gration compl√®te r√©ussie !</h4>
                        <p><strong>Contexte DMP:</strong></p>
                        <pre>${JSON.stringify(mockIntegration.context.state, null, 2)}</pre>
                        <p><strong>Hook useDMP:</strong></p>
                        <pre>${JSON.stringify(mockIntegration.hook, null, 2)}</pre>
                        <p><strong>Statistiques du composant:</strong></p>
                        <pre>${JSON.stringify(stats, null, 2)}</pre>
                        <p><strong>Statistiques du hook:</strong></p>
                        <pre>${JSON.stringify(hookStats, null, 2)}</pre>
                        <p><strong>V√©rification:</strong> Toutes les donn√©es sont correctement transmises et calcul√©es.</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Test √©chou√© !</h4>
                        <p>Erreur: ${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
