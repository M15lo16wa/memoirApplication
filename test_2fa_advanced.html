<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Avanc√© 2FA - DMP Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .info {
            color: #17a2b8;
        }

        .warning {
            color: #ffc107;
        }

        .highlight {
            color: #e83e8c;
            font-weight: bold;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px;
        }

        .code-display {
            background: #e9ecef;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        .code-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            letter-spacing: 3px;
        }

        .timer {
            font-size: 14px;
            color: #6c757d;
            margin-top: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-success {
            background-color: #28a745;
        }

        .status-error {
            background-color: #dc3545;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-info {
            background-color: #17a2b8;
        }
    </style>
</head>

<body>
    <h1>üß™ Test Avanc√© du Flux 2FA - DMP Application</h1>

    <div class="test-section">
        <h2>1. üîç Analyse de la R√©ponse Backend</h2>
        <p>Ce test analyse en d√©tail la r√©ponse du backend pour identifier la structure exacte.</p>

        <div>
            <label>Num√©ro d'assur√©:</label>
            <input type="text" id="numeroAssure" value="TEMP000005" placeholder="TEMP000005">
        </div>

        <div>
            <label>Mot de passe:</label>
            <input type="password" id="password" value="passer123" placeholder="passer123">
        </div>

        <button onclick="analyzeBackendResponse()">üîç Analyser R√©ponse Backend</button>
        <button onclick="clearLogs()">üóëÔ∏è Effacer Logs</button>

        <div class="log-area" id="analysisLogs"></div>
    </div>

    <div class="test-section">
        <h2>2. üîê Extraction du Code 2FA</h2>
        <p>Extraction automatique du code 2FA depuis la r√©ponse du backend.</p>

        <button onclick="extract2FACode()">üîë Extraire Code 2FA</button>
        <button onclick="simulateBackendCode()">üé≤ Simuler Code Backend</button>

        <div id="codeDisplay" class="code-display" style="display: none;">
            <h3>Code 2FA G√©n√©r√© par le Backend</h3>
            <div class="code-number" id="extractedCode">------</div>
            <div class="timer" id="codeTimer">Valide pour: -- secondes</div>
            <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                üí° Utilisez ce code pour tester la validation 2FA
            </p>
        </div>

        <div class="log-area" id="extractionLogs"></div>
    </div>

    <div class="test-section">
        <h2>3. üß™ Test de Validation avec Code Extrait</h2>
        <p>Test automatique de la validation 2FA avec le code extrait du backend.</p>

        <div>
            <label>Code 2FA (6 chiffres):</label>
            <input type="text" id="code2FA" placeholder="Code extrait automatiquement" maxlength="6">
        </div>

        <button onclick="testWithExtractedCode()">üß™ Tester avec Code Extrait</button>
        <button onclick="autoFillCode()">üìù Remplir Code Automatiquement</button>

        <div class="log-area" id="validationLogs"></div>
    </div>

    <div class="test-section">
        <h2>4. üìä √âtat et D√©bogage</h2>
        <p>Informations d√©taill√©es sur l'√©tat de l'authentification et le d√©bogage.</p>

        <button onclick="checkAuthState()">üîç V√©rifier √âtat Auth</button>
        <button onclick="clearAuthData()">üö™ D√©connexion</button>
        <button onclick="debug2FAFlow()">üêõ D√©boguer Flux 2FA</button>

        <div class="log-area" id="stateLogs"></div>
    </div>

    <script>
        let extractedCode = null;
        let codeExpiryTime = null;
        let timerInterval = null;

        // Fonction utilitaire pour ajouter des logs
        function addLog(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollTop + 1000;
        }

        // Fonction pour effacer tous les logs
        function clearLogs() {
            document.getElementById('analysisLogs').innerHTML = '';
            document.getElementById('extractionLogs').innerHTML = '';
            document.getElementById('validationLogs').innerHTML = '';
            document.getElementById('stateLogs').innerHTML = '';
        }

        // Analyser la r√©ponse du backend
        async function analyzeBackendResponse() {
            const numeroAssure = document.getElementById('numeroAssure').value;
            const password = document.getElementById('password').value;

            addLog('analysisLogs', 'üîç D√©but de l\'analyse de la r√©ponse backend...', 'info');
            addLog('analysisLogs', `üì§ Envoi des identifiants: ${numeroAssure}`, 'info');

            try {
                const response = await fetch('http://localhost:3000/api/patient/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_assure: numeroAssure,
                        mot_de_passe: password
                    })
                });

                const data = await response.json();
                addLog('analysisLogs', '‚úÖ R√©ponse re√ßue du serveur', 'success');
                addLog('analysisLogs', `üìä Donn√©es compl√®tes: ${JSON.stringify(data, null, 2)}`, 'info');

                // Analyse d√©taill√©e de la structure
                addLog('analysisLogs', 'üîç Analyse de la structure de r√©ponse:', 'info');
                addLog('analysisLogs', `  - Status: ${data.status || 'Non d√©fini'}`, 'info');
                addLog('analysisLogs', `  - Message: ${data.message || 'Non d√©fini'}`, 'info');
                addLog('analysisLogs', `  - TwoFactorSecret: ${data.twoFactorSecret || 'Non d√©fini'}`, 'info');
                addLog('analysisLogs', `  - Data: ${data.data ? 'Pr√©sent' : 'Absent'}`, 'info');

                if (data.data) {
                    addLog('analysisLogs', `  - Data.patient: ${data.data.patient ? 'Pr√©sent' : 'Absent'}`, 'info');
                    if (data.data.patient) {
                        addLog('analysisLogs', `  - Patient.two_factor_secret: ${data.data.patient.two_factor_secret || 'Non d√©fini'}`, 'info');
                    }
                }

                // D√©tection automatique de la 2FA
                const requires2FA = data?.status === 'requires2FA' ||
                    data?.requires2FA ||
                    data?.message?.includes('2FA') ||
                    data?.message?.includes('double facteur') ||
                    data?.message?.includes('authentification') ||
                    data?.two_factor_required ||
                    data?.data?.two_factor_required;

                addLog('analysisLogs', `üîê D√©tection 2FA: ${requires2FA ? 'REQUISE' : 'NON REQUISE'}`, requires2FA ? 'warning' : 'success');

                if (requires2FA) {
                    addLog('analysisLogs', 'üéØ 2FA d√©tect√©e - Pr√™t pour l\'extraction du code', 'warning');

                    // Stocker les donn√©es pour l'extraction
                    window.backendResponse = data;
                    addLog('analysisLogs', 'üíæ Donn√©es stock√©es pour extraction ult√©rieure', 'success');
                }

            } catch (error) {
                addLog('analysisLogs', `‚ùå Erreur lors de l'analyse: ${error.message}`, 'error');
            }
        }

        // Extraire le code 2FA
        function extract2FACode() {
            if (!window.backendResponse) {
                addLog('extractionLogs', '‚ùå Aucune r√©ponse backend disponible. Analysez d\'abord la r√©ponse.', 'error');
                return;
            }

            addLog('extractionLogs', 'üîë D√©but de l\'extraction du code 2FA...', 'info');

            const response = window.backendResponse;
            addLog('extractionLogs', `üìä Analyse de la r√©ponse: ${JSON.stringify(response, null, 2)}`, 'info');

            // Chercher le code 2FA dans diff√©rentes propri√©t√©s
            let code = null;
            let source = '';

            // V√©rifier les propri√©t√©s directes
            if (response.twoFactorSecret) {
                code = response.twoFactorSecret;
                source = 'response.twoFactorSecret';
            } else if (response.two_factor_secret) {
                code = response.two_factor_secret;
                source = 'response.two_factor_secret';
            } else if (response.data?.two_factor_secret) {
                code = response.data.two_factor_secret;
                source = 'response.data.two_factor_secret';
            } else if (response.data?.patient?.two_factor_secret) {
                code = response.data.patient.two_factor_secret;
                source = 'response.data.patient.two_factor_secret';
            }

            if (code) {
                addLog('extractionLogs', `‚úÖ Code 2FA trouv√©: ${code} (source: ${source})`, 'success');

                // Extraire le code √† 6 chiffres (si c'est un secret complet)
                if (code.length > 6) {
                    // C'est un secret, pas un code - on ne peut pas l'extraire directement
                    addLog('extractionLogs', `‚ö†Ô∏è Secret 2FA trouv√© (${code.length} caract√®res), mais pas de code √† 6 chiffres`, 'warning');
                    addLog('extractionLogs', 'üí° Le code √† 6 chiffres est g√©n√©r√© dynamiquement par le backend', 'info');

                    // Simuler un code de test
                    simulateBackendCode();
                } else {
                    extractedCode = code;
                    displayCode(code);
                }
            } else {
                addLog('extractionLogs', '‚ùå Aucun code 2FA trouv√© dans la r√©ponse', 'error');
                addLog('extractionLogs', 'üîç Propri√©t√©s disponibles:', 'info');
                addLog('extractionLogs', `  - ${Object.keys(response).join(', ')}`, 'info');
            }
        }

        // Simuler un code g√©n√©r√© par le backend
        function simulateBackendCode() {
            addLog('extractionLogs', 'üé≤ Simulation d\'un code 2FA g√©n√©r√© par le backend...', 'info');

            // G√©n√©rer un code de test (6 chiffres)
            const testCode = Math.floor(100000 + Math.random() * 900000).toString();
            extractedCode = testCode;

            addLog('extractionLogs', `‚úÖ Code de test g√©n√©r√©: ${testCode}`, 'success');
            addLog('extractionLogs', 'üí° Note: Ceci est un code simul√©. En production, le backend g√©n√®re le vrai code.', 'warning');

            displayCode(testCode);
        }

        // Afficher le code extrait
        function displayCode(code) {
            document.getElementById('extractedCode').textContent = code;
            document.getElementById('codeDisplay').style.display = 'block';

            // Simuler une expiration dans 30 secondes
            codeExpiryTime = new Date(Date.now() + 30000);
            startCodeTimer();

            addLog('extractionLogs', `üì± Code affich√©: ${code}`, 'success');
            addLog('extractionLogs', '‚è∞ Code valide pour 30 secondes (simulation)', 'info');
        }

        // D√©marrer le timer du code
        function startCodeTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }

            timerInterval = setInterval(() => {
                if (codeExpiryTime) {
                    const remaining = Math.max(0, Math.floor((codeExpiryTime - new Date()) / 1000));
                    document.getElementById('codeTimer').textContent = `Valide pour: ${remaining} secondes`;

                    if (remaining <= 0) {
                        clearInterval(timerInterval);
                        document.getElementById('codeTimer').textContent = 'Code expir√©';
                        document.getElementById('codeTimer').style.color = '#dc3545';
                        addLog('extractionLogs', '‚è∞ Code 2FA expir√©', 'warning');
                    }
                }
            }, 1000);
        }

        // Remplir automatiquement le code
        function autoFillCode() {
            if (extractedCode) {
                document.getElementById('code2FA').value = extractedCode;
                addLog('validationLogs', `üìù Code ${extractedCode} rempli automatiquement`, 'success');
            } else {
                addLog('validationLogs', '‚ùå Aucun code extrait disponible', 'error');
            }
        }

        // Tester avec le code extrait
        async function testWithExtractedCode() {
            const code2FA = document.getElementById('code2FA').value;

            if (!code2FA || code2FA.length !== 6) {
                addLog('validationLogs', '‚ùå Code 2FA invalide - doit contenir 6 chiffres', 'error');
                return;
            }

            addLog('validationLogs', `üîê Test de validation 2FA avec le code: ${code2FA}`, 'info');

            if (extractedCode && code2FA === extractedCode) {
                addLog('validationLogs', '‚úÖ Code correspond au code extrait du backend', 'success');
            } else {
                addLog('validationLogs', '‚ö†Ô∏è Code ne correspond pas au code extrait', 'warning');
            }

            try {
                const response = await fetch('http://localhost:3000/api/auth/validate-2fa-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        twoFactorToken: code2FA
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('validationLogs', '‚úÖ Validation 2FA r√©ussie!', 'success');
                    addLog('validationLogs', `üìä R√©ponse: ${JSON.stringify(data, null, 2)}`, 'info');
                    addLog('validationLogs', 'üöÄ Redirection vers la page principale...', 'success');
                } else {
                    addLog('validationLogs', `‚ùå √âchec de la validation 2FA: ${data.message}`, 'error');
                    addLog('validationLogs', 'üí° V√©rifiez que le code est correct et qu\'il n\'a pas expir√©', 'info');
                }

            } catch (error) {
                addLog('validationLogs', `‚ùå Erreur lors de la validation: ${error.message}`, 'error');
            }
        }

        // V√©rifier l'√©tat de l'authentification
        function checkAuthState() {
            addLog('stateLogs', 'üîç V√©rification de l\'√©tat d\'authentification...', 'info');

            const jwt = localStorage.getItem('jwt');
            const token = localStorage.getItem('token');
            const patient = localStorage.getItem('patient');
            const medecin = localStorage.getItem('medecin');

            addLog('stateLogs', `<span class="status-indicator ${jwt ? 'status-success' : 'status-warning'}"></span>JWT Token: ${jwt ? 'Pr√©sent' : 'Absent'}`, jwt ? 'success' : 'warning');
            addLog('stateLogs', `<span class="status-indicator ${token ? 'status-success' : 'status-warning'}"></span>General Token: ${token ? 'Pr√©sent' : 'Absent'}`, token ? 'success' : 'warning');
            addLog('stateLogs', `<span class="status-indicator ${patient ? 'status-success' : 'status-warning'}"></span>Patient: ${patient ? 'Connect√©' : 'Non connect√©'}`, patient ? 'success' : 'warning');
            addLog('stateLogs', `<span class="status-indicator ${medecin ? 'status-success' : 'status-warning'}"></span>M√©decin: ${medecin ? 'Connect√©' : 'Non connect√©'}`, medecin ? 'success' : 'warning');

            if (patient) {
                try {
                    const patientData = JSON.parse(patient);
                    addLog('stateLogs', `üìä Donn√©es patient: ${JSON.stringify(patientData, null, 2)}`, 'info');
                } catch (e) {
                    addLog('stateLogs', '‚ùå Erreur lors du parsing des donn√©es patient', 'error');
                }
            }
        }

        // D√©boguer le flux 2FA
        function debug2FAFlow() {
            addLog('stateLogs', 'üêõ D√©bogage du flux 2FA...', 'info');

            addLog('stateLogs', 'üìã √âtat actuel:', 'info');
            addLog('stateLogs', `  - Code extrait: ${extractedCode || 'Aucun'}`, 'info');
            addLog('stateLogs', `  - R√©ponse backend: ${window.backendResponse ? 'Disponible' : 'Non disponible'}`, 'info');
            addLog('stateLogs', `  - Timer actif: ${timerInterval ? 'Oui' : 'Non'}`, 'info');

            if (window.backendResponse) {
                addLog('stateLogs', 'üîç Structure de la r√©ponse backend:', 'info');
                addLog('stateLogs', `  - Status: ${window.backendResponse.status}`, 'info');
                addLog('stateLogs', `  - Message: ${window.backendResponse.message}`, 'info');
                addLog('stateLogs', `  - TwoFactorSecret: ${window.backendResponse.twoFactorSecret}`, 'info');
            }

            addLog('stateLogs', 'üí° Conseils de d√©bogage:', 'info');
            addLog('stateLogs', '  1. V√©rifiez les logs du backend pour le code g√©n√©r√©', 'info');
            addLog('stateLogs', '  2. Assurez-vous que le code n\'a pas expir√©', 'info');
            addLog('stateLogs', '  3. V√©rifiez la structure de la r√©ponse backend', 'info');
        }

        // D√©connexion
        function clearAuthData() {
            localStorage.removeItem('jwt');
            localStorage.removeItem('token');
            localStorage.removeItem('patient');
            localStorage.removeItem('medecin');

            addLog('stateLogs', 'üö™ D√©connexion effectu√©e - Donn√©es supprim√©es', 'success');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            addLog('stateLogs', 'üöÄ Application de test 2FA avanc√©e initialis√©e', 'success');
            addLog('stateLogs', 'üì± Pr√™t pour les tests d\'authentification avanc√©s', 'info');
            addLog('stateLogs', 'üí° Commencez par analyser la r√©ponse du backend', 'info');
        });
    </script>
</body>

</html>