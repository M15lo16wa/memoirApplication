<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Flux 2FA - DMP Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .info {
            color: #17a2b8;
        }

        .warning {
            color: #ffc107;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        input {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <h1>üß™ Test du Flux 2FA - DMP Application</h1>

    <div class="test-section">
        <h2>1. Test de Connexion Patient avec 2FA</h2>
        <p>Ce test simule le flux de connexion patient qui d√©clenche la 2FA.</p>

        <div>
            <label>Num√©ro d'assur√©:</label>
            <input type="text" id="numeroAssure" value="TEMP000005" placeholder="TEMP000005">
        </div>

        <div>
            <label>Mot de passe:</label>
            <input type="password" id="password" value="password123" placeholder="password123">
        </div>

        <button onclick="testPatientLogin()">üîµ Tester Connexion Patient</button>
        <button onclick="clearLogs()">üóëÔ∏è Effacer Logs</button>

        <div class="log-area" id="loginLogs"></div>
    </div>

    <div class="test-section">
        <h2>2. Test de Validation 2FA</h2>
        <p>Ce test simule la validation du code 2FA.</p>

        <div>
            <label>Code 2FA (6 chiffres):</label>
            <input type="text" id="code2FA" placeholder="123456" maxlength="6">
        </div>

        <button onclick="test2FAValidation()">üîê Tester Validation 2FA</button>

        <div class="log-area" id="validationLogs"></div>
    </div>

    <div class="test-section">
        <h2>3. √âtat de l'Application</h2>
        <p>Informations sur l'√©tat actuel de l'authentification.</p>

        <button onclick="checkAuthState()">üîç V√©rifier √âtat Auth</button>
        <button onclick="clearAuthData()">üö™ D√©connexion</button>

        <div class="log-area" id="stateLogs"></div>
    </div>

    <div class="test-section">
        <h2>4. Logs de D√©bogage</h2>
        <p>Logs d√©taill√©s du flux d'authentification.</p>

        <div class="log-area" id="debugLogs"></div>
    </div>

    <script>
        // Fonction utilitaire pour ajouter des logs
        function addLog(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            container.appendChild(logEntry);
            container.scrollTop = container.scrollTop + 1000;
        }

        // Fonction pour effacer tous les logs
        function clearLogs() {
            document.getElementById('loginLogs').innerHTML = '';
            document.getElementById('validationLogs').innerHTML = '';
            document.getElementById('stateLogs').innerHTML = '';
            document.getElementById('debugLogs').innerHTML = '';
        }

        // Test de connexion patient
        async function testPatientLogin() {
            const numeroAssure = document.getElementById('numeroAssure').value;
            const password = document.getElementById('password').value;

            addLog('loginLogs', 'üîµ D√©but du test de connexion patient...', 'info');
            addLog('loginLogs', `üì§ Envoi des identifiants: ${numeroAssure}`, 'info');

            try {
                // Simuler l'appel API
                const response = await fetch('http://localhost:3000/api/patient/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        numero_assure: numeroAssure,
                        password: password
                    })
                });

                const data = await response.json();
                addLog('loginLogs', '‚úÖ R√©ponse re√ßue du serveur', 'success');
                addLog('loginLogs', `üìä Donn√©es: ${JSON.stringify(data, null, 2)}`, 'info');

                // Analyser la r√©ponse pour d√©tecter la 2FA
                const requires2FA = data?.status === 'requires2FA' ||
                    data?.requires2FA ||
                    data?.message?.includes('2FA') ||
                    data?.message?.includes('double facteur') ||
                    data?.message?.includes('authentification') ||
                    data?.two_factor_required ||
                    data?.data?.two_factor_required;

                addLog('loginLogs', `üîç Analyse 2FA: ${requires2FA ? 'REQUISE' : 'NON REQUISE'}`, requires2FA ? 'warning' : 'success');

                if (requires2FA) {
                    addLog('loginLogs', 'üîê 2FA d√©tect√©e - Affichage du composant Setup2FA', 'warning');

                    // Extraire les donn√©es patient
                    const patientData = data.data?.patient || data.patient || data.data || data;
                    addLog('loginLogs', `üë§ Donn√©es patient extraites: ${JSON.stringify(patientData, null, 2)}`, 'info');

                    // V√©rifier la pr√©sence du secret 2FA
                    if (patientData.two_factor_secret) {
                        addLog('loginLogs', `üîë Secret 2FA trouv√©: ${patientData.two_factor_secret}`, 'success');
                    } else {
                        addLog('loginLogs', '‚ö†Ô∏è Secret 2FA manquant dans les donn√©es patient', 'error');
                        addLog('loginLogs', `üîç Propri√©t√©s disponibles: ${Object.keys(patientData).join(', ')}`, 'info');
                    }
                } else {
                    addLog('loginLogs', '‚úÖ Connexion normale - Stockage du token et redirection', 'success');
                }

            } catch (error) {
                addLog('loginLogs', `‚ùå Erreur lors de la connexion: ${error.message}`, 'error');
            }
        }

        // Test de validation 2FA
        async function test2FAValidation() {
            const code2FA = document.getElementById('code2FA').value;

            if (!code2FA || code2FA.length !== 6) {
                addLog('validationLogs', '‚ùå Code 2FA invalide - doit contenir 6 chiffres', 'error');
                return;
            }

            addLog('validationLogs', `üîê Tentative de validation 2FA avec le code: ${code2FA}`, 'info');

            try {
                // Simuler l'appel API de validation
                const response = await fetch('http://localhost:3000/api/auth/validate-2fa-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        twoFactorToken: code2FA
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addLog('validationLogs', '‚úÖ Validation 2FA r√©ussie!', 'success');
                    addLog('validationLogs', `üìä R√©ponse: ${JSON.stringify(data, null, 2)}`, 'info');
                    addLog('validationLogs', 'üöÄ Redirection vers la page principale...', 'success');
                } else {
                    addLog('validationLogs', `‚ùå √âchec de la validation 2FA: ${data.message}`, 'error');
                }

            } catch (error) {
                addLog('validationLogs', `‚ùå Erreur lors de la validation: ${error.message}`, 'error');
            }
        }

        // V√©rifier l'√©tat de l'authentification
        function checkAuthState() {
            addLog('stateLogs', 'üîç V√©rification de l\'√©tat d\'authentification...', 'info');

            // V√©rifier le localStorage
            const jwt = localStorage.getItem('jwt');
            const token = localStorage.getItem('token');
            const patient = localStorage.getItem('patient');
            const medecin = localStorage.getItem('medecin');

            addLog('stateLogs', `üîë JWT Token: ${jwt ? 'Pr√©sent' : 'Absent'}`, jwt ? 'success' : 'warning');
            addLog('stateLogs', `üîë General Token: ${token ? 'Pr√©sent' : 'Absent'}`, token ? 'success' : 'warning');
            addLog('stateLogs', `üë§ Patient: ${patient ? 'Connect√©' : 'Non connect√©'}`, patient ? 'success' : 'warning');
            addLog('stateLogs', `üë®‚Äç‚öïÔ∏è M√©decin: ${medecin ? 'Connect√©' : 'Non connect√©'}`, medecin ? 'success' : 'warning');

            if (patient) {
                try {
                    const patientData = JSON.parse(patient);
                    addLog('stateLogs', `üìä Donn√©es patient: ${JSON.stringify(patientData, null, 2)}`, 'info');
                } catch (e) {
                    addLog('stateLogs', '‚ùå Erreur lors du parsing des donn√©es patient', 'error');
                }
            }
        }

        // D√©connexion
        function clearAuthData() {
            localStorage.removeItem('jwt');
            localStorage.removeItem('token');
            localStorage.removeItem('patient');
            localStorage.removeItem('medecin');

            addLog('stateLogs', 'üö™ D√©connexion effectu√©e - Donn√©es supprim√©es', 'success');
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function () {
            addLog('debugLogs', 'üöÄ Application de test 2FA initialis√©e', 'success');
            addLog('debugLogs', 'üì± Pr√™t pour les tests d\'authentification', 'info');
        });
    </script>
</body>

</html>