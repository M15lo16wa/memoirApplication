<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Structure RÃ©ponse 2FA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .success {
            color: #28a745;
        }

        .error {
            color: #dc3545;
        }

        .warning {
            color: #ffc107;
        }

        .info {
            color: #17a2b8;
        }

        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
        }

        .debug {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .problem {
            background: #ffebee;
            border: 1px solid #f44336;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .solution {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <h1>ğŸ” Test Structure RÃ©ponse API 2FA</h1>

    <div class="container">
        <h2>ğŸ“‹ ProblÃ¨me IdentifiÃ©</h2>
        <div class="problem">
            <p><strong>Erreur :</strong> "DonnÃ©es de configuration 2FA incomplÃ¨tes dans la rÃ©ponse"</p>
            <p><strong>Cause :</strong> Le composant Setup2FA cherche des donnÃ©es dans la mauvaise structure de rÃ©ponse
            </p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ” Structure de RÃ©ponse RÃ©elle du Serveur</h2>
        <p>D'aprÃ¨s les logs, le serveur retourne :</p>
        <div class="code">{
            "status": "success",
            "message": "Configuration 2FA initialisÃ©e - Code envoyÃ© par email",
            "data": { ... }
            }</div>

        <div class="debug">
            <p><strong>Logs du serveur :</strong></p>
            <ul>
                <li>ğŸ“§ Email envoyÃ© vers: saza@hopital.sn</li>
                <li>ğŸ” Secret 2FA: 0d258c49...</li>
                <li>âœ… Statut: 200 (succÃ¨s)</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ› Ce que le Composant Cherchait (INCORRECT)</h2>
        <div class="code">// âŒ RECHERCHE INCORRECTE
            const userEmail = response.data?.user?.email || response.data?.email || response.email;
            const secretKey = response.data?.secret || response.data?.two_factor_secret || response.secret;

            // ProblÃ¨me : response.data.user.email n'existe pas !
            // ProblÃ¨me : response.data.secret n'existe pas !</div>

        <div class="error">
            <p><strong>RÃ©sultat :</strong> userEmail et secretKey sont undefined â†’ Erreur "DonnÃ©es incomplÃ¨tes"</p>
        </div>
    </div>

    <div class="container">
        <h2>âœ… Correction AppliquÃ©e</h2>
        <div class="solution">
            <p><strong>Solution :</strong> Utiliser userData pour l'email et chercher le secret dans la rÃ©ponse</p>
        </div>

        <div class="code">// âœ… CORRECTION APPLIQUÃ‰E
            // L'email vient de userData, pas de la rÃ©ponse
            const userEmail = userData?.email || userData?.professionnel?.email || userData?.user?.email;

            // Le secret peut Ãªtre dans diffÃ©rentes propriÃ©tÃ©s de la rÃ©ponse
            const secretKey = response.data?.secret ||
            response.data?.two_factor_secret ||
            response.data?.setupSecret ||
            response.data?.totpSecret ||
            response.secret;

            // Validation : on a besoin de l'email (depuis userData)
            if (userEmail) {
            // Configuration rÃ©ussie
            } else {
            throw new Error('Email utilisateur non trouvÃ© dans les donnÃ©es utilisateur');
            }</div>
    </div>

    <div class="container">
        <h2>ğŸ” Logs de DÃ©bogage AjoutÃ©s</h2>
        <p>Des logs dÃ©taillÃ©s ont Ã©tÃ© ajoutÃ©s pour identifier la structure exacte :</p>
        <div class="code">console.log('ğŸ” DEBUG - Structure dÃ©taillÃ©e de la rÃ©ponse:', {
            responseKeys: Object.keys(response),
            dataKeys: response.data ? Object.keys(response.data) : 'N/A',
            dataDataKeys: response.data?.data ? Object.keys(response.data.data) : 'N/A',
            userDataEmail: userData?.email,
            userDataProfessionnelEmail: userData?.professionnel?.email
            });

            console.log('ğŸ” DEBUG - DonnÃ©es extraites:', {
            userEmail: userEmail || 'NON TROUVÃ‰',
            secretKey: secretKey ? 'TROUVÃ‰' : 'NON TROUVÃ‰',
            recoveryCodesCount: recoveryCodes.length
            });</div>
    </div>

    <div class="container">
        <h2>ğŸ“Š DonnÃ©es Utilisateur Disponibles</h2>
        <p>D'aprÃ¨s les logs, userData contient :</p>
        <div class="code">{
            "id_professionnel": 79,
            "nom": "Sakura",
            "prenom": "Saza",
            "numero_adeli": "AH23456780",
            "role": "medecin",
            "email": "saza@hopital.sn", // â† EMAIL DISPONIBLE ICI
            ...
            }</div>

        <div class="info">
            <p><strong>Note :</strong> L'email est disponible dans userData.email, pas dans la rÃ©ponse de l'API</p>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª Test de la Correction</h2>
        <p>Pour vÃ©rifier que la correction fonctionne :</p>
        <ol>
            <li><strong>Ouvrir la console du navigateur</strong></li>
            <li><strong>Tenter la configuration 2FA</strong> pour le compte mÃ©decin</li>
            <li><strong>VÃ©rifier les nouveaux logs de dÃ©bogage</strong> dans la console</li>
            <li><strong>Confirmer que la deuxiÃ¨me Ã©tape s'affiche</strong> correctement</li>
        </ol>

        <div class="debug">
            <p><strong>Logs attendus aprÃ¨s correction :</strong></p>
            <ul>
                <li>ğŸ” DEBUG - Structure dÃ©taillÃ©e de la rÃ©ponse: {...}</li>
                <li>ğŸ” DEBUG - DonnÃ©es extraites: {userEmail: "saza@hopital.sn", secretKey: "TROUVÃ‰", ...}</li>
                <li>âœ… Email de configuration envoyÃ© avec succÃ¨s</li>
            </ul>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ”® AmÃ©liorations Futures</h2>
        <ul>
            <li><strong>Standardisation des rÃ©ponses API</strong> - DÃ©finir une structure de rÃ©ponse cohÃ©rente</li>
            <li><strong>Documentation API</strong> - Documenter exactement ce que chaque endpoint retourne</li>
            <li><strong>Tests automatisÃ©s</strong> - Valider les structures de rÃ©ponse</li>
            <li><strong>Gestion d'erreur centralisÃ©e</strong> - Traiter les erreurs de maniÃ¨re uniforme</li>
        </ul>
    </div>

    <script>
        console.log('ğŸ” Test Structure RÃ©ponse 2FA - Page chargÃ©e');

        // Simulation de la structure de rÃ©ponse rÃ©elle
        const mockResponse = {
            status: 'success',
            message: 'Configuration 2FA initialisÃ©e - Code envoyÃ© par email',
            data: {
                // Le secret pourrait Ãªtre ici, mais pas forcÃ©ment
                // secret: '0d258c49...',
                // two_factor_secret: '0d258c49...'
            }
        };

        // Simulation des donnÃ©es utilisateur
        const mockUserData = {
            id_professionnel: 79,
            nom: 'Sakura',
            prenom: 'Saza',
            numero_adeli: 'AH23456780',
            role: 'medecin',
            email: 'saza@hopital.sn'
        };

        console.log('ğŸ§ª Structure de rÃ©ponse simulÃ©e:', mockResponse);
        console.log('ğŸ‘¤ DonnÃ©es utilisateur simulÃ©es:', mockUserData);
        console.log('ğŸ“§ Email disponible dans userData:', mockUserData.email);

        // Test de la logique de correction
        const userEmail = mockUserData?.email || mockUserData?.professionnel?.email || mockUserData?.user?.email;
        const secretKey = mockResponse.data?.secret || mockResponse.data?.two_factor_secret || mockResponse.data?.setupSecret || mockResponse.data?.totpSecret || mockResponse.secret;

        console.log('ğŸ” Test extraction des donnÃ©es:', {
            userEmail: userEmail || 'NON TROUVÃ‰',
            secretKey: secretKey ? 'TROUVÃ‰' : 'NON TROUVÃ‰'
        });

        if (userEmail) {
            console.log('âœ… Email trouvÃ©:', userEmail);
        } else {
            console.log('âŒ Email non trouvÃ©');
        }
    </script>
</body>

</html>