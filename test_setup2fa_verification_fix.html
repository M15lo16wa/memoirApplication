<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Setup2FA - Correction Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }

        .info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }

        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }

        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }

        .button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .button-primary {
            background-color: #007bff;
            color: white;
        }

        .button-secondary {
            background-color: #6c757d;
            color: white;
        }

        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>üîê Test Setup2FA - Correction Verification</h1>

    <div class="test-case info">
        <h3>üìã Test de la correction de l'appel √† verifyAndEnable2FA dans Setup2FA</h3>
        <p>Ce test v√©rifie que Setup2FA appelle maintenant verifyAndEnable2FA avec le format complet attendu par le
            serveur</p>
    </div>

    <div class="test-case">
        <h3>üß™ Test 1: Simulation de buildUserParams</h3>
        <div>
            <label>Type d'utilisateur :</label>
            <select id="user-type">
                <option value="professionnel">Professionnel (m√©decin)</option>
                <option value="patient">Patient</option>
            </select>
            <button onclick="testBuildUserParams()" class="button button-primary">Tester buildUserParams</button>
        </div>
        <div id="result-buildparams"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 2: Simulation de l'appel verifyAndEnable2FA</h3>
        <div>
            <label>Code de v√©rification :</label>
            <input type="text" id="verification-code" value="277315" placeholder="123456" maxlength="6">
            <button onclick="testVerifyAndEnable2FA()" class="button button-secondary">Tester Appel</button>
        </div>
        <div id="result-verify"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 3: Flux complet Setup2FA</h3>
        <div>
            <button onclick="testCompleteSetup2FAFlow()" class="button button-primary">Tester Flux Complet</button>
        </div>
        <div id="result-complete"></div>
    </div>

    <script>
        // Simulation de la fonction buildUserParams de Setup2FA
        function buildUserParams(userData) {
            console.log('üîê DEBUG - buildUserParams - Structure userData:', {
                keys: Object.keys(userData || {}),
                numero_assure: userData?.numero_assure,
                numero_adeli: userData?.numero_adeli,
                email: userData?.email,
                email_professionnel: userData?.email_professionnel,
                email_medecin: userData?.email_medecin,
                professionnel: userData?.professionnel ? Object.keys(userData.professionnel) : 'N/A',
                type: userData?.type,
                id: userData?.id,
                id_professionnel: userData?.id_professionnel,
                userId: userData?.userId
            });

            if (userData.numero_assure) {
                return {
                    userType: 'patient',
                    identifier: userData.numero_assure,
                    userId: userData.id_patient || userData.id || userData.userId ? String(userData.id_patient || userData.id || userData.userId) : undefined
                };
            }
            if (userData.numero_adeli) {
                return {
                    userType: 'professionnel',
                    identifier: userData.numero_adeli,
                    userId: userData.id || userData.id_professionnel || userData.userId ? String(userData.id || userData.id_professionnel || userData.userId) : undefined
                };
            }

            // Recherche d'email dans diff√©rentes propri√©t√©s
            const email = userData.email ||
                userData.email_professionnel ||
                userData.email_medecin ||
                userData.professionnel?.email ||
                userData.user?.email;

            if (email) {
                console.log('üîê DEBUG - Email trouv√© pour buildUserParams:', email);
                return {
                    userType: 'professionnel',
                    identifier: email,
                    userId: userData.id || userData.id_professionnel || userData.userId ? String(userData.id || userData.id_professionnel || userData.userId) : undefined
                };
            }

            if (userData.id || userData.userId) {
                return {
                    userType: userData.type === 'patient' ? 'patient' : 'professionnel',
                    identifier: String(userData.id || userData.userId),
                    userId: String(userData.id || userData.userId)
                };
            }

            console.error('‚ùå DEBUG - Impossible de d√©terminer userType et identifier:', userData);
            throw new Error("Impossible de d√©terminer 'userType' et 'identifier' pour setup2FA");
        }

        // Simulation de la fonction verifyAndEnable2FA corrig√©e
        async function verifyAndEnable2FA(params) {
            try {
                // Extraire les param√®tres
                const { verificationCode, userType, identifier } = params;

                console.log('üîê VerifyAndEnable2FA - Param√®tres re√ßus:', { verificationCode, userType, identifier });

                // V√©rifier que tous les param√®tres requis sont pr√©sents
                if (!verificationCode || !userType || !identifier) {
                    throw new Error('verificationCode, userType et identifier sont requis pour verifyAndEnable2FA');
                }

                // üîç D√âBOGAGE - V√©rifier la structure de la requ√™te
                const requestData = {
                    verificationCode,
                    userType,
                    identifier
                };

                console.log('üîê DEBUG - Donn√©es de requ√™te envoy√©es:', requestData);

                // Simulation de l'appel API
                const response = await simulateApiCall('/auth/verify-2fa', requestData);

                console.log('‚úÖ VerifyAndEnable2FA - R√©ponse re√ßue:', response.data);

                return response.data;
            } catch (error) {
                console.error('‚ùå VerifyAndEnable2FA - Erreur:', error);
                throw error;
            }
        }

        // Simulation d'un appel API
        async function simulateApiCall(endpoint, data) {
            console.log(`üåê Simulation API call: ${endpoint}`, data);

            // Simuler un d√©lai r√©seau
            await new Promise(resolve => setTimeout(resolve, 500));

            // Simuler une r√©ponse r√©ussie
            return {
                data: {
                    success: true,
                    message: '2FA v√©rifi√© et activ√© avec succ√®s',
                    status: 'success'
                }
            };
        }

        // Test 1: Simulation de buildUserParams
        function testBuildUserParams() {
            const result = document.getElementById('result-buildparams');
            const userType = document.getElementById('user-type').value;

            let userData;
            if (userType === 'professionnel') {
                userData = {
                    numero_adeli: 'AH23456780',
                    email: 'medecin@hopital.sn',
                    type: 'professionnel',
                    id: 79
                };
            } else {
                userData = {
                    numero_assure: '1234567890123',
                    type: 'patient',
                    id: 123
                };
            }

            try {
                const params = buildUserParams(userData);

                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ buildUserParams r√©ussi:</h4>
                        <pre>Donn√©es utilisateur: ${JSON.stringify(userData, null, 2)}</pre>
                        <pre>Param√®tres g√©n√©r√©s: ${JSON.stringify(params, null, 2)}</pre>
                        <p><strong>userType:</strong> ${params.userType}</p>
                        <p><strong>identifier:</strong> ${params.identifier}</p>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå buildUserParams √©chou√©:</h4>
                        <pre>Erreur: ${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test 2: Simulation de l'appel verifyAndEnable2FA
        async function testVerifyAndEnable2FA() {
            const result = document.getElementById('result-verify');
            const code = document.getElementById('verification-code').value;
            const userType = document.getElementById('user-type').value;

            // Simuler les donn√©es utilisateur
            const userData = userType === 'professionnel' ? {
                numero_adeli: 'AH23456780',
                email: 'medecin@hopital.sn',
                type: 'professionnel'
            } : {
                numero_assure: '1234567890123',
                type: 'patient'
            };

            try {
                // CORRECTION : Construire les param√®tres complets comme dans Setup2FA
                const userParams = buildUserParams(userData);
                const verificationParams = {
                    verificationCode: code,
                    userType: userParams.userType,
                    identifier: userParams.identifier
                };

                console.log('üîê DEBUG - Param√®tres de v√©rification envoy√©s:', verificationParams);

                const response = await verifyAndEnable2FA(verificationParams);

                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ verifyAndEnable2FA r√©ussi:</h4>
                        <pre>Param√®tres envoy√©s: ${JSON.stringify(verificationParams, null, 2)}</pre>
                        <pre>R√©ponse re√ßue: ${JSON.stringify(response, null, 2)}</pre>
                        <p><strong>Statut :</strong> ${response.status}</p>
                        <p><strong>Message :</strong> ${response.message}</p>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå verifyAndEnable2FA √©chou√©:</h4>
                        <pre>Erreur: ${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test 3: Flux complet Setup2FA
        async function testCompleteSetup2FAFlow() {
            const result = document.getElementById('result-complete');
            const code = document.getElementById('verification-code').value;
            const userType = document.getElementById('user-type').value;

            result.innerHTML = `
                <div class="info">
                    <h4>üîÑ Test du flux complet Setup2FA...</h4>
                    <p>Type utilisateur: <strong>${userType}</strong></p>
                    <p>Code de v√©rification: <strong>${code}</strong></p>
                    <div class="animate-spin">‚è≥</div>
                </div>
            `;

            try {
                // Simuler le flux complet de Setup2FA
                const userData = userType === 'professionnel' ? {
                    numero_adeli: 'AH23456780',
                    email: 'medecin@hopital.sn',
                    type: 'professionnel'
                } : {
                    numero_assure: '1234567890123',
                    type: 'patient'
                };

                // √âtape 1: Construire les param√®tres utilisateur
                const userParams = buildUserParams(userData);
                console.log('üîê DEBUG - Param√®tres utilisateur g√©n√©r√©s:', userParams);

                // √âtape 2: Construire les param√®tres de v√©rification
                const verificationParams = {
                    verificationCode: code,
                    userType: userParams.userType,
                    identifier: userParams.identifier
                };
                console.log('üîê DEBUG - Param√®tres de v√©rification:', verificationParams);

                // √âtape 3: Appeler verifyAndEnable2FA
                const response = await verifyAndEnable2FA(verificationParams);

                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Flux complet Setup2FA r√©ussi:</h4>
                        <pre>Donn√©es utilisateur: ${JSON.stringify(userData, null, 2)}</pre>
                        <pre>Param√®tres utilisateur: ${JSON.stringify(userParams, null, 2)}</pre>
                        <pre>Param√®tres de v√©rification: ${JSON.stringify(verificationParams, null, 2)}</pre>
                        <pre>R√©ponse finale: ${JSON.stringify(response, null, 2)}</pre>
                        <p><strong>Statut :</strong> ${response.status}</p>
                        <p><strong>Message :</strong> ${response.message}</p>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Flux complet Setup2FA √©chou√©:</h4>
                        <pre>Erreur: ${error.message}</pre>
                    </div>
                `;
            }
        }

        // Initialisation
        window.onload = function () {
            console.log('üîê Test Setup2FA - Corrections de v√©rification charg√©es');
            console.log('üìä Fonctions disponibles:', {
                buildUserParams: typeof buildUserParams,
                verifyAndEnable2FA: typeof verifyAndEnable2FA,
                simulateApiCall: typeof simulateApiCall
            });
        };
    </script>
</body>

</html>