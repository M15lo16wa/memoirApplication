<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Format Imbriqu√© 2FA</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .button { padding: 10px 20px; margin: 5px; border: none; border-radius: 5px; cursor: pointer; }
        .button-primary { background-color: #007bff; color: white; }
        .button-secondary { background-color: #6c757d; color: white; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 3px; }
    </style>
</head>

<body>
    <h1>üîê Test Format Imbriqu√© 2FA</h1>

    <div class="test-case info">
        <h3>üìã Test du format imbriqu√© attendu par le serveur</h3>
        <p>Ce test v√©rifie que le format de donn√©es imbriqu√© est correctement g√©n√©r√©</p>
    </div>

    <div class="test-case">
        <h3>üß™ Test 1: G√©n√©ration du format imbriqu√©</h3>
        <div>
            <label>Code de v√©rification :</label>
            <input type="text" id="verification-code" value="466509" placeholder="123456" maxlength="6">
            <button onclick="testFormatImbrique()" class="button button-primary">Tester Format Imbriqu√©</button>
        </div>
        <div id="result-format"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 2: Simulation de l'API call</h3>
        <div>
            <button onclick="testApiCall()" class="button button-secondary">Tester Appel API</button>
        </div>
        <div id="result-api"></div>
    </div>

    <div class="test-case">
        <h3>üß™ Test 3: Comparaison des formats</h3>
        <div>
            <button onclick="testComparaison()" class="button button-primary">Comparer Formats</button>
        </div>
        <div id="result-comparaison"></div>
    </div>

    <script>
        // Simulation de la fonction verifyAndEnable2FA corrig√©e
        async function verifyAndEnable2FA(params) {
            try {
                // Extraire les param√®tres
                const { verificationCode, userType, identifier } = params;
                
                console.log('üîê VerifyAndEnable2FA - Param√®tres re√ßus:', { verificationCode, userType, identifier });

                // V√©rifier que tous les param√®tres requis sont pr√©sents
                if (!verificationCode || !userType || !identifier) {
                    throw new Error('verificationCode, userType et identifier sont requis pour verifyAndEnable2FA');
                }

                // üîç D√âBOGAGE - V√©rifier la structure de la requ√™te
                const requestData = {
                    verificationCode: {
                        verificationCode,
                        userType,
                        identifier
                    }
                };
                
                console.log('üîê DEBUG - Donn√©es de requ√™te envoy√©es:', requestData);
                
                // CORRECTION : Le serveur attend un format imbriqu√© avec verificationCode comme cl√© principale
                const response = await simulateApiCall('/auth/verify-2fa', requestData);
                
                console.log('‚úÖ VerifyAndEnable2FA - R√©ponse re√ßue:', response.data);
                
                return response.data;
            } catch (error) {
                console.error('‚ùå VerifyAndEnable2FA - Erreur:', error);
                throw error;
            }
        }

        // Simulation d'un appel API
        async function simulateApiCall(endpoint, data) {
            console.log(`üåê Simulation API call: ${endpoint}`, data);

            // Simuler un d√©lai r√©seau
            await new Promise(resolve => setTimeout(resolve, 500));

            // Simuler une r√©ponse r√©ussie
            return {
                data: {
                    success: true,
                    message: '2FA v√©rifi√© et activ√© avec succ√®s',
                    status: 'success'
                }
            };
        }

        // Test 1: G√©n√©ration du format imbriqu√©
        function testFormatImbrique() {
            const result = document.getElementById('result-format');
            const code = document.getElementById('verification-code').value;
            
            // Simuler les param√®tres re√ßus
            const params = {
                verificationCode: code,
                userType: 'professionnel',
                identifier: 'AH23456780'
            };
            
            // G√©n√©rer le format imbriqu√© attendu par le serveur
            const requestData = {
                verificationCode: {
                    verificationCode: params.verificationCode,
                    userType: params.userType,
                    identifier: params.identifier
                }
            };
            
            result.innerHTML = `
                <div class="success">
                    <h4>‚úÖ Format imbriqu√© g√©n√©r√©:</h4>
                    <p><strong>Param√®tres re√ßus:</strong></p>
                    <pre>${JSON.stringify(params, null, 2)}</pre>
                    <p><strong>Format imbriqu√© envoy√© au serveur:</strong></p>
                    <pre>${JSON.stringify(requestData, null, 2)}</pre>
                    <p><strong>Structure:</strong> Le serveur attend <code>verificationCode</code> comme cl√© principale contenant un objet</p>
                </div>
            `;
        }

        // Test 2: Simulation de l'API call
        async function testApiCall() {
            const result = document.getElementById('result-api');
            const code = document.getElementById('verification-code').value;
            
            result.innerHTML = `
                <div class="info">
                    <h4>üîÑ Test de l'appel API...</h4>
                    <p>Simulation de l'appel √† verifyAndEnable2FA</p>
                </div>
            `;
            
            try {
                const params = {
                    verificationCode: code,
                    userType: 'professionnel',
                    identifier: 'AH23456780'
                };
                
                const response = await verifyAndEnable2FA(params);
                
                result.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ Appel API r√©ussi:</h4>
                        <pre>Param√®tres envoy√©s: ${JSON.stringify(params, null, 2)}</pre>
                        <pre>R√©ponse re√ßue: ${JSON.stringify(response, null, 2)}</pre>
                        <p><strong>Statut :</strong> ${response.status}</p>
                        <p><strong>Message :</strong> ${response.message}</p>
                    </div>
                `;
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Appel API √©chou√©:</h4>
                        <pre>Erreur: ${error.message}</pre>
                    </div>
                `;
            }
        }

        // Test 3: Comparaison des formats
        function testComparaison() {
            const result = document.getElementById('result-comparaison');
            
            // Format AVANT (incorrect)
            const formatAvant = {
                verificationCode: "466509",
                userType: "professionnel",
                identifier: "AH23456780"
            };
            
            // Format APR√àS (correct - imbriqu√©)
            const formatApres = {
                verificationCode: {
                    verificationCode: "466509",
                    userType: "professionnel",
                    identifier: "AH23456780"
                }
            };
            
            result.innerHTML = `
                <div class="info">
                    <h4>üìä Comparaison des formats:</h4>
                    
                    <h5>‚ùå Format AVANT (incorrect):</h5>
                    <pre>${JSON.stringify(formatAvant, null, 2)}</pre>
                    <p><strong>Probl√®me:</strong> Structure plate, le serveur attend un format imbriqu√©</p>
                    
                    <h5>‚úÖ Format APR√àS (correct):</h5>
                    <pre>${JSON.stringify(formatApres, null, 2)}</pre>
                    <p><strong>Avantage:</strong> Structure imbriqu√©e attendue par le serveur</p>
                    
                    <h5>üîç Diff√©rences cl√©s:</h5>
                    <ul>
                        <li><strong>Cl√© principale:</strong> <code>verificationCode</code> contient maintenant un objet</li>
                        <li><strong>Structure:</strong> Niveaux d'imbrication respect√©s</li>
                        <li><strong>Compatibilit√©:</strong> Format attendu par le serveur</li>
                    </ul>
                </div>
            `;
        }

        // Initialisation
        window.onload = function () {
            console.log('üîê Test Format Imbriqu√© 2FA - Charg√©');
            console.log('üìä Fonctions disponibles:', {
                verifyAndEnable2FA: typeof verifyAndEnable2FA,
                simulateApiCall: typeof simulateApiCall
            });
        };
    </script>
</body>

</html>
